<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Enhanced Dynamic Movie Network</title>
        <script src="https://d3js.org/d3.v7.min.js"></script>
        <style>
            :root {
                --primary-color: #1a1a2e;
                --secondary-color: #16213e;
                --accent-color: #e94560;
                --gemini-accent: #f6e05e;
                --text-color: #ffffff;
                --text-secondary: #b0b0b0;
                --glass-bg: rgba(255, 255, 255, 0.1);
                --glass-border: rgba(255, 255, 255, 0.2);
                --success-color: #10b981;
                --warning-color: #f59e0b;
            }

            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
                background: linear-gradient(
                    135deg,
                    var(--primary-color),
                    var(--secondary-color)
                );
                color: var(--text-color);
                min-height: 100vh;
                overflow: hidden;
            }

            .header {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                z-index: 1000;
                background: var(--glass-bg);
                backdrop-filter: blur(10px);
                border-bottom: 1px solid var(--glass-border);
                padding: 15px 20px;
                display: flex;
                align-items: center;
                justify-content: space-between;
                flex-wrap: wrap;
                gap: 15px;
            }

            .header h1 {
                font-size: 1.8rem;
                background: linear-gradient(
                    45deg,
                    var(--accent-color),
                    var(--gemini-accent)
                );
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                background-clip: text;
            }

            .search-container {
                display: flex;
                align-items: center;
                gap: 10px;
                flex: 1;
                max-width: 400px;
                position: relative;
            }

            .search-input {
                flex: 1;
                background: rgba(255, 255, 255, 0.1);
                border: 1px solid var(--glass-border);
                color: var(--text-color);
                border-radius: 25px;
                padding: 10px 20px;
                font-size: 14px;
                transition: all 0.3s ease;
            }

            .search-input:focus {
                outline: none;
                border-color: var(--accent-color);
                box-shadow: 0 0 0 3px rgba(233, 69, 96, 0.1);
            }

            .search-btn,
            .control-btn {
                background: linear-gradient(
                    45deg,
                    var(--accent-color),
                    var(--gemini-accent)
                );
                border: none;
                color: white;
                padding: 10px 15px;
                border-radius: 20px;
                cursor: pointer;
                font-weight: bold;
                transition: transform 0.2s;
                font-size: 12px;
            }

            .search-btn:hover,
            .control-btn:hover {
                transform: scale(1.05);
            }

            .controls {
                display: flex;
                gap: 10px;
                align-items: center;
            }

            .stats {
                background: rgba(0, 0, 0, 0.3);
                padding: 5px 15px;
                border-radius: 15px;
                font-size: 12px;
                color: var(--text-secondary);
            }

            .network-container {
                position: fixed;
                top: 80px;
                left: 0;
                right: 0;
                bottom: 0;
                overflow: hidden;
            }

            #network-svg {
                width: 100%;
                height: 100%;
                cursor: grab;
            }

            #network-svg:active {
                cursor: grabbing;
            }

            .node {
                cursor: pointer;
                stroke: #fff;
                stroke-width: 2px;
                transition: all 0.3s ease;
            }

            .node:hover {
                stroke-width: 3px;
                filter: brightness(1.2);
            }

            .node.expanding {
                stroke: var(--gemini-accent);
                stroke-width: 4px;
                animation: pulse 1s infinite;
            }

            @keyframes pulse {
                0%,
                100% {
                    opacity: 1;
                }
                50% {
                    opacity: 0.7;
                }
            }

            .link {
                stroke: rgba(255, 255, 255, 0.3);
                stroke-width: 1px;
                transition: all 0.3s ease;
            }

            .link.new {
                stroke: var(--gemini-accent);
                stroke-width: 2px;
                animation: fadeIn 1s ease-in-out;
            }

            @keyframes fadeIn {
                from {
                    opacity: 0;
                    stroke-width: 4px;
                }
                to {
                    opacity: 1;
                    stroke-width: 2px;
                }
            }

            .node-label {
                font-size: 11px;
                fill: white;
                text-anchor: middle;
                pointer-events: none;
                text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
                font-weight: 500;
            }

            .tooltip {
                position: absolute;
                background: rgba(0, 0, 0, 0.9);
                color: white;
                padding: 12px;
                border-radius: 8px;
                pointer-events: none;
                font-size: 13px;
                border: 1px solid var(--glass-border);
                max-width: 250px;
                z-index: 1001;
                backdrop-filter: blur(10px);
            }

            .sidebar {
                position: fixed;
                right: 20px;
                top: 100px;
                width: 280px;
                background: var(--glass-bg);
                backdrop-filter: blur(10px);
                border: 1px solid var(--glass-border);
                border-radius: 15px;
                padding: 20px;
                max-height: calc(100vh - 120px);
                overflow-y: auto;
                z-index: 999;
            }

            .sidebar h3 {
                color: var(--gemini-accent);
                margin-bottom: 15px;
                font-size: 1.1rem;
            }

            .movie-item {
                background: rgba(255, 255, 255, 0.05);
                border-radius: 8px;
                padding: 12px;
                margin-bottom: 10px;
                cursor: pointer;
                transition: all 0.3s ease;
                border: 1px solid transparent;
                position: relative;
            }

            .movie-item:hover {
                background: rgba(255, 255, 255, 0.1);
                border-color: var(--accent-color);
                transform: translateY(-2px);
            }

            .movie-header {
                display: flex;
                justify-content: space-between;
                align-items: flex-start;
                margin-bottom: 6px;
            }

            .movie-title {
                font-weight: bold;
                color: var(--text-color);
                font-size: 13px;
                flex: 1;
                margin-right: 8px;
            }

            .movie-rating {
                color: var(--gemini-accent);
                font-size: 11px;
                font-weight: bold;
                white-space: nowrap;
            }

            .movie-meta {
                color: var(--text-secondary);
                font-size: 10px;
                margin-bottom: 4px;
            }

            .movie-year {
                color: var(--text-secondary);
                font-size: 11px;
            }

            .movie-runtime,
            .movie-watchers {
                color: var(--text-secondary);
            }

            .movie-genres {
                color: #10b981;
                font-size: 10px;
                margin-bottom: 4px;
                font-style: italic;
            }

            .movie-depth {
                color: var(--text-secondary);
                font-size: 9px;
                margin-bottom: 6px;
            }

            .load-details {
                background: linear-gradient(
                    45deg,
                    var(--accent-color),
                    var(--gemini-accent)
                );
                color: white;
                padding: 4px 8px;
                border-radius: 4px;
                font-size: 9px;
                text-align: center;
                margin-top: 6px;
                transition: transform 0.2s;
            }

            .load-details:hover {
                transform: scale(1.05);
            }

            .loading {
                display: none;
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: var(--glass-bg);
                backdrop-filter: blur(10px);
                border: 1px solid var(--glass-border);
                border-radius: 15px;
                padding: 30px;
                text-align: center;
                z-index: 1002;
            }

            .spinner {
                width: 40px;
                height: 40px;
                border: 4px solid rgba(255, 255, 255, 0.1);
                border-left: 4px solid var(--accent-color);
                border-radius: 50%;
                animation: spin 1s linear infinite;
                margin: 0 auto 15px;
            }

            @keyframes spin {
                0% {
                    transform: rotate(0deg);
                }
                100% {
                    transform: rotate(360deg);
                }
            }

            .notification {
                position: fixed;
                top: 90px;
                right: 20px;
                background: var(--success-color);
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                font-size: 14px;
                z-index: 1003;
                transform: translateX(100%);
                transition: transform 0.3s ease;
            }

            .notification.show {
                transform: translateX(0);
            }

            .notification.error {
                background: var(--accent-color);
            }

            .help-panel {
                position: fixed;
                bottom: 20px;
                left: 20px;
                background: var(--glass-bg);
                backdrop-filter: blur(10px);
                border: 1px solid var(--glass-border);
                border-radius: 10px;
                padding: 15px;
                font-size: 12px;
                max-width: 300px;
            }

            .help-panel h4 {
                color: var(--gemini-accent);
                margin-bottom: 8px;
            }

            .help-panel ul {
                list-style: none;
                padding: 0;
            }

            .help-panel li {
                margin-bottom: 4px;
                color: var(--text-secondary);
            }

            .modal {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                backdrop-filter: blur(5px);
                z-index: 2000;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .modal-content {
                background: var(--glass-bg);
                backdrop-filter: blur(20px);
                border: 1px solid var(--glass-border);
                border-radius: 20px;
                width: 90%;
                max-width: 500px;
                max-height: 80vh;
                overflow: hidden;
                animation: modalSlideIn 0.3s ease-out;
            }

            @keyframes modalSlideIn {
                from {
                    transform: scale(0.9);
                    opacity: 0;
                }
                to {
                    transform: scale(1);
                    opacity: 1;
                }
            }

            .modal-header {
                padding: 20px;
                border-bottom: 1px solid var(--glass-border);
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            .modal-header h3 {
                margin: 0;
                color: var(--gemini-accent);
            }

            .close-btn {
                background: none;
                border: none;
                color: var(--text-secondary);
                font-size: 24px;
                cursor: pointer;
                padding: 0;
                width: 30px;
                height: 30px;
                display: flex;
                align-items: center;
                justify-content: center;
                border-radius: 50%;
                transition: all 0.3s ease;
            }

            .close-btn:hover {
                background: rgba(255, 255, 255, 0.1);
                color: var(--text-color);
            }

            .modal-body {
                padding: 20px;
                max-height: 60vh;
                overflow-y: auto;
            }

            .modal-footer {
                padding: 20px;
                border-top: 1px solid var(--glass-border);
                display: flex;
                gap: 10px;
                justify-content: flex-end;
            }

            .form-group {
                margin-bottom: 20px;
            }

            .form-group label {
                display: block;
                margin-bottom: 8px;
                color: var(--text-color);
                font-weight: 500;
            }

            .form-group input,
            .form-group textarea {
                width: 100%;
                background: rgba(255, 255, 255, 0.1);
                border: 1px solid var(--glass-border);
                color: var(--text-color);
                border-radius: 10px;
                padding: 12px;
                font-size: 14px;
                transition: all 0.3s ease;
                box-sizing: border-box;
            }

            .form-group input:focus,
            .form-group textarea:focus {
                outline: none;
                border-color: var(--accent-color);
                box-shadow: 0 0 0 3px rgba(233, 69, 96, 0.1);
            }

            .form-group textarea {
                resize: vertical;
                min-height: 80px;
            }

            .network-preview {
                background: rgba(255, 255, 255, 0.05);
                border-radius: 10px;
                padding: 15px;
                margin-top: 10px;
            }

            .network-preview h4 {
                margin: 0 0 10px 0;
                color: var(--gemini-accent);
                font-size: 14px;
            }

            .control-btn.primary {
                background: linear-gradient(
                    45deg,
                    var(--success-color),
                    var(--gemini-accent)
                );
            }

            .saved-networks {
                max-height: 400px;
                overflow-y: auto;
            }

            .saved-network-item {
                background: rgba(255, 255, 255, 0.05);
                border: 1px solid var(--glass-border);
                border-radius: 10px;
                padding: 15px;
                margin-bottom: 10px;
                cursor: pointer;
                transition: all 0.3s ease;
            }

            .saved-network-item:hover {
                background: rgba(255, 255, 255, 0.1);
                border-color: var(--accent-color);
                transform: translateY(-2px);
            }

            .saved-network-item.selected {
                border-color: var(--gemini-accent);
                background: rgba(246, 224, 94, 0.1);
            }

            .network-item-header {
                display: flex;
                justify-content: space-between;
                align-items: flex-start;
                margin-bottom: 8px;
            }

            .network-item-title {
                font-weight: bold;
                color: var(--text-color);
                font-size: 16px;
            }

            .network-item-date {
                color: var(--text-secondary);
                font-size: 11px;
            }

            .network-item-description {
                color: var(--text-secondary);
                font-size: 13px;
                margin-bottom: 10px;
                line-height: 1.4;
            }

            .network-item-stats {
                display: flex;
                gap: 15px;
                font-size: 12px;
                color: var(--text-secondary);
            }

            .network-item-actions {
                display: flex;
                gap: 8px;
                margin-top: 10px;
            }

            .action-btn {
                background: rgba(255, 255, 255, 0.1);
                border: 1px solid var(--glass-border);
                color: var(--text-color);
                padding: 6px 12px;
                border-radius: 6px;
                font-size: 11px;
                cursor: pointer;
                transition: all 0.3s ease;
            }

            .action-btn:hover {
                background: rgba(255, 255, 255, 0.2);
            }

            .action-btn.danger {
                border-color: var(--accent-color);
                color: var(--accent-color);
            }

            .action-btn.danger:hover {
                background: rgba(233, 69, 96, 0.1);
            }

            /* Advanced Search Panel */
            .search-panel {
                position: fixed;
                left: 20px;
                top: 100px;
                width: 320px;
                background: var(--glass-bg);
                backdrop-filter: blur(10px);
                border: 1px solid var(--glass-border);
                border-radius: 15px;
                padding: 20px;
                max-height: calc(100vh - 120px);
                overflow-y: auto;
                z-index: 999;
                transform: translateX(-120%);
                transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1);
            }

            .search-panel.open {
                transform: translateX(0);
            }

            .search-panel h3 {
                color: var(--gemini-accent);
                margin-bottom: 20px;
                font-size: 1.2rem;
                display: flex;
                align-items: center;
                justify-content: space-between;
            }

            .close-panel {
                background: none;
                border: none;
                color: var(--text-secondary);
                cursor: pointer;
                font-size: 18px;
                padding: 5px;
                border-radius: 50%;
                transition: all 0.3s ease;
            }

            .close-panel:hover {
                background: rgba(255, 255, 255, 0.1);
                color: var(--text-color);
            }

            .filter-group {
                margin-bottom: 25px;
            }

            .filter-group h4 {
                color: var(--text-color);
                margin-bottom: 12px;
                font-size: 14px;
                display: flex;
                align-items: center;
                gap: 8px;
            }

            .filter-input {
                width: 100%;
                background: rgba(255, 255, 255, 0.1);
                border: 1px solid var(--glass-border);
                color: var(--text-color);
                border-radius: 8px;
                padding: 8px 12px;
                font-size: 13px;
                transition: all 0.3s ease;
            }

            .filter-input:focus {
                outline: none;
                border-color: var(--accent-color);
                box-shadow: 0 0 0 2px rgba(233, 69, 96, 0.1);
            }

            .range-container {
                display: flex;
                gap: 10px;
                align-items: center;
            }

            .range-slider {
                width: 100%;
                height: 6px;
                border-radius: 3px;
                background: rgba(255, 255, 255, 0.2);
                outline: none;
                -webkit-appearance: none;
            }

            .range-slider::-webkit-slider-thumb {
                -webkit-appearance: none;
                appearance: none;
                width: 16px;
                height: 16px;
                border-radius: 50%;
                background: var(--accent-color);
                cursor: pointer;
            }

            .range-slider::-moz-range-thumb {
                width: 16px;
                height: 16px;
                border-radius: 50%;
                background: var(--accent-color);
                cursor: pointer;
                border: none;
            }

            .range-values {
                display: flex;
                justify-content: space-between;
                font-size: 11px;
                color: var(--text-secondary);
                margin-top: 5px;
            }

            .genre-tags {
                display: flex;
                flex-wrap: wrap;
                gap: 6px;
                margin-top: 8px;
            }

            .genre-tag {
                background: rgba(255, 255, 255, 0.1);
                border: 1px solid var(--glass-border);
                color: var(--text-color);
                padding: 4px 10px;
                border-radius: 12px;
                font-size: 11px;
                cursor: pointer;
                transition: all 0.3s ease;
            }

            .genre-tag:hover {
                background: rgba(255, 255, 255, 0.2);
            }

            .genre-tag.selected {
                background: var(--accent-color);
                border-color: var(--accent-color);
            }

            .filter-actions {
                display: flex;
                gap: 10px;
                margin-top: 20px;
            }

            .filter-btn {
                flex: 1;
                background: linear-gradient(
                    45deg,
                    var(--accent-color),
                    var(--gemini-accent)
                );
                border: none;
                color: white;
                padding: 10px;
                border-radius: 8px;
                cursor: pointer;
                font-weight: bold;
                font-size: 12px;
                transition: transform 0.2s;
            }

            .filter-btn:hover {
                transform: scale(1.05);
            }

            .filter-btn.secondary {
                background: rgba(255, 255, 255, 0.1);
                border: 1px solid var(--glass-border);
            }

            /* Search Results */
            .search-results {
                position: absolute;
                top: 100%;
                left: 0;
                right: 0;
                background: var(--glass-bg);
                backdrop-filter: blur(10px);
                border: 1px solid var(--glass-border);
                border-radius: 0 0 15px 15px;
                max-height: 300px;
                overflow-y: auto;
                z-index: 1001;
                display: none;
            }

            .search-result-item {
                padding: 12px 20px;
                border-bottom: 1px solid var(--glass-border);
                cursor: pointer;
                transition: background 0.3s ease;
            }

            .search-result-item:hover {
                background: rgba(255, 255, 255, 0.1);
            }

            .search-result-item:last-child {
                border-bottom: none;
            }

            .result-title {
                font-weight: bold;
                color: var(--text-color);
                font-size: 14px;
            }

            .result-meta {
                color: var(--text-secondary);
                font-size: 12px;
                margin-top: 4px;
            }

            /* Path Finder */
            .path-finder {
                background: rgba(255, 255, 255, 0.05);
                border-radius: 10px;
                padding: 15px;
                margin-bottom: 20px;
            }

            .path-inputs {
                display: flex;
                gap: 10px;
                margin-bottom: 10px;
            }

            .path-input {
                flex: 1;
                background: rgba(255, 255, 255, 0.1);
                border: 1px solid var(--glass-border);
                color: var(--text-color);
                border-radius: 6px;
                padding: 6px 10px;
                font-size: 12px;
            }

            .path-result {
                font-size: 12px;
                color: var(--text-secondary);
                margin-top: 10px;
                padding: 8px;
                background: rgba(0, 0, 0, 0.2);
                border-radius: 6px;
                display: none;
            }

            .path-highlight {
                stroke: var(--gemini-accent) !important;
                stroke-width: 4px !important;
                animation: pathPulse 2s infinite;
            }

            @keyframes pathPulse {
                0%,
                100% {
                    opacity: 1;
                }
                50% {
                    opacity: 0.6;
                }
            }

            .node.highlighted,
            .link.highlighted,
            .node-label.highlighted {
                opacity: 1 !important;
            }

            .node.dimmed,
            .link.dimmed,
            .node-label.dimmed {
                opacity: 0.2 !important;
            }

            .movie-item.highlighted {
                border-color: var(--gemini-accent);
                background: rgba(246, 224, 94, 0.1);
            }

            .movie-item.dimmed {
                opacity: 0.4;
            }

            @media (max-width: 768px) {
                .header {
                    flex-direction: column;
                    padding: 10px;
                }

                .sidebar {
                    position: fixed;
                    bottom: 0;
                    right: 0;
                    left: 0;
                    top: auto;
                    width: auto;
                    max-height: 200px;
                    border-radius: 15px 15px 0 0;
                }

                .help-panel {
                    display: none;
                }

                .network-container {
                    bottom: 220px;
                }

                .modal-content {
                    width: 95%;
                    margin: 10px;
                }

                .search-panel {
                    width: calc(100% - 40px);
                    left: 20px;
                    right: 20px;
                }
            }
        </style>
    </head>
    <body>
        <div class="header">
            <h1>🎬 Enhanced Movie Network</h1>
            <div class="search-container">
                <input
                    type="text"
                    class="search-input"
                    id="movieSearch"
                    placeholder="Search for a movie to add..."
                />
                <button class="search-btn" onclick="searchAndAddMovie()">
                    🔍 Add
                </button>
                <div class="search-results" id="searchResults"></div>
            </div>
            <div class="controls">
                <div class="stats" id="networkStats">
                    0 movies, 0 connections
                </div>
                <button class="control-btn" onclick="toggleSearchPanel()">
                    🔍 Filters
                </button>
                <button class="control-btn" onclick="showSaveDialog()">
                    💾 Save
                </button>
                <button class="control-btn" onclick="showLoadDialog()">
                    📂 Load
                </button>
                <button class="control-btn" onclick="clearNetwork()">
                    🗑️ Clear
                </button>
                <button class="control-btn" onclick="centerNetwork()">
                    🎯 Center
                </button>
                <button class="control-btn" onclick="toggleLabels()">
                    🏷️ Labels
                </button>
            </div>
        </div>

        <!-- Advanced Search Panel -->
        <div class="search-panel" id="searchPanel">
            <h3>
                🔍 Advanced Search & Filters
                <button class="close-panel" onclick="toggleSearchPanel()">
                    &times;
                </button>
            </h3>

            <div class="filter-group">
                <h4>🎬 Quick Find in Network</h4>
                <input
                    type="text"
                    class="filter-input"
                    id="quickSearch"
                    placeholder="Start typing a movie title..."
                />
            </div>

            <div class="filter-group">
                <h4>🛤️ Path Finder</h4>
                <div class="path-finder">
                    <div class="path-inputs">
                        <input
                            type="text"
                            class="path-input"
                            id="pathFrom"
                            placeholder="From movie..."
                        />
                        <input
                            type="text"
                            class="path-input"
                            id="pathTo"
                            placeholder="To movie..."
                        />
                    </div>
                    <button class="filter-btn" onclick="findAndShowPath()">
                        Find Path
                    </button>
                    <div class="path-result" id="pathResult"></div>
                </div>
            </div>

            <div class="filter-group">
                <h4>📅 Year Range</h4>
                <div class="range-container">
                    <input
                        type="range"
                        class="range-slider"
                        id="yearMin"
                        min="1900"
                        max="2024"
                        value="1900"
                    />
                    <input
                        type="range"
                        class="range-slider"
                        id="yearMax"
                        min="1900"
                        max="2024"
                        value="2024"
                    />
                </div>
                <div class="range-values">
                    <span id="yearMinValue">1900</span>
                    <span id="yearMaxValue">2024</span>
                </div>
            </div>

            <div class="filter-group">
                <h4>⭐ Rating Range</h4>
                <div class="range-container">
                    <input
                        type="range"
                        class="range-slider"
                        id="ratingMin"
                        min="0"
                        max="10"
                        step="0.1"
                        value="0"
                    />
                    <input
                        type="range"
                        class="range-slider"
                        id="ratingMax"
                        min="0"
                        max="10"
                        step="0.1"
                        value="10"
                    />
                </div>
                <div class="range-values">
                    <span id="ratingMinValue">0.0</span>
                    <span id="ratingMaxValue">10.0</span>
                </div>
            </div>

            <div class="filter-group">
                <h4>🎭 Genres</h4>
                <div class="genre-tags" id="genreTags"></div>
            </div>

            <div class="filter-actions">
                <button class="filter-btn" onclick="applyFilters()">
                    Apply Filters
                </button>
                <button class="filter-btn secondary" onclick="clearFilters()">
                    Clear All
                </button>
            </div>
        </div>

        <div class="network-container">
            <svg id="network-svg"></svg>
        </div>

        <div class="sidebar">
            <h3>🎭 Network Movies</h3>
            <div id="movieList">
                <div
                    style="
                        text-align: center;
                        color: var(--text-secondary);
                        padding: 20px;
                    "
                >
                    Search for a movie to start building your network!
                </div>
            </div>
        </div>

        <div class="loading" id="loadingIndicator">
            <div class="spinner"></div>
            <div>Loading...</div>
        </div>

        <div class="notification" id="notification"></div>

        <div class="help-panel">
            <h4>💡 How to Use</h4>
            <ul>
                <li>🔍 Search and add movies</li>
                <li>🖱️ Click nodes to expand</li>
                <li>🖱️ Drag nodes to rearrange</li>
                <li>🖱️ Scroll to zoom</li>
                <li>🖱️ Hover for details</li>
            </ul>
        </div>

        <div class="tooltip" id="tooltip" style="display: none"></div>

        <!-- Save Dialog -->
        <div class="modal" id="saveModal" style="display: none">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>💾 Save Network</h3>
                    <button class="close-btn" onclick="closeSaveDialog()">
                        &times;
                    </button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="networkName">Network Name:</label>
                        <input
                            type="text"
                            id="networkName"
                            placeholder="Enter network name..."
                        />
                    </div>
                    <div class="form-group">
                        <label for="networkDescription"
                            >Description (optional):</label
                        >
                        <textarea
                            id="networkDescription"
                            placeholder="Describe your network..."
                        ></textarea>
                    </div>
                    <div class="network-preview">
                        <h4>Network Summary:</h4>
                        <div id="savePreview">Loading...</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="control-btn" onclick="closeSaveDialog()">
                        Cancel
                    </button>
                    <button class="control-btn primary" onclick="saveNetwork()">
                        💾 Save Network
                    </button>
                </div>
            </div>
        </div>

        <!-- Load Dialog -->
        <div class="modal" id="loadModal" style="display: none">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>📂 Load Network</h3>
                    <button class="close-btn" onclick="closeLoadDialog()">
                        &times;
                    </button>
                </div>
                <div class="modal-body">
                    <div class="saved-networks" id="savedNetworksList">
                        Loading saved networks...
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="control-btn" onclick="closeLoadDialog()">
                        Cancel
                    </button>
                    <button class="control-btn" onclick="refreshNetworksList()">
                        🔄 Refresh
                    </button>
                </div>
            </div>
        </div>

        <script>
            class EnhancedMovieNetwork {
                constructor() {
                    this.apiBase = "http://127.0.0.1:5000/api";
                    this.nodes = [];
                    this.links = [];
                    this.nodeMap = new Map();
                    this.showLabels = true;
                    this.nextNodeId = 0;
                    this.selectedGenres = new Set();
                    this.currentPath = [];

                    this.init();
                }

                init() {
                    this.setupVisualization();
                    this.setupEventListeners();
                    this.setupRangeSliders();
                    this.populateGenreTags();
                }

                setupVisualization() {
                    const svg = d3.select("#network-svg");
                    const width = window.innerWidth;
                    const height = window.innerHeight - 80;

                    this.svg = svg;
                    this.width = width;
                    this.height = height;

                    this.g = svg.append("g");

                    this.zoom = d3
                        .zoom()
                        .scaleExtent([0.1, 4])
                        .on("zoom", (event) => {
                            this.g.attr("transform", event.transform);
                        });

                    svg.call(this.zoom);

                    this.simulation = d3
                        .forceSimulation()
                        .force(
                            "link",
                            d3
                                .forceLink()
                                .id((d) => d.id)
                                .distance(120),
                        )
                        .force("charge", d3.forceManyBody().strength(-400))
                        .force("center", d3.forceCenter(width / 2, height / 2))
                        .force("collision", d3.forceCollide().radius(35));

                    this.linkContainer = this.g
                        .append("g")
                        .attr("class", "links");
                    this.nodeContainer = this.g
                        .append("g")
                        .attr("class", "nodes");
                    this.labelContainer = this.g
                        .append("g")
                        .attr("class", "labels");

                    this.colorScale = d3
                        .scaleOrdinal()
                        .domain([0, 1, 2, 3])
                        .range(["#e94560", "#f6e05e", "#10b981", "#3b82f6"]);
                }

                setupEventListeners() {
                    document
                        .getElementById("movieSearch")
                        .addEventListener("keypress", (e) => {
                            if (e.key === "Enter") this.searchAndAddMovie();
                        });

                    document
                        .getElementById("quickSearch")
                        .addEventListener("input", (e) => {
                            this.highlightByQuery(e.target.value);
                        });

                    window.addEventListener("resize", () =>
                        this.handleResize(),
                    );
                }

                setupRangeSliders() {
                    const sliders = [
                        { id: "yearMin", valueId: "yearMinValue" },
                        { id: "yearMax", valueId: "yearMaxValue" },
                        { id: "ratingMin", valueId: "ratingMinValue" },
                        { id: "ratingMax", valueId: "ratingMaxValue" },
                    ];

                    sliders.forEach((slider) => {
                        const element = document.getElementById(slider.id);
                        const valueElement = document.getElementById(
                            slider.valueId,
                        );
                        element.addEventListener("input", (e) => {
                            valueElement.textContent = e.target.value;
                        });
                    });
                }

                populateGenreTags() {
                    const commonGenres = [
                        "Action",
                        "Adventure",
                        "Comedy",
                        "Drama",
                        "Horror",
                        "Thriller",
                        "Romance",
                        "Sci-Fi",
                        "Fantasy",
                        "Crime",
                        "Mystery",
                        "Animation",
                    ];
                    const genreContainer = document.getElementById("genreTags");
                    genreContainer.innerHTML = commonGenres
                        .map(
                            (genre) =>
                                `<div class="genre-tag" onclick="movieNetwork.toggleGenre(this, '${genre}')">${genre}</div>`,
                        )
                        .join("");
                }

                toggleGenre(element, genre) {
                    element.classList.toggle("selected");
                    if (this.selectedGenres.has(genre)) {
                        this.selectedGenres.delete(genre);
                    } else {
                        this.selectedGenres.add(genre);
                    }
                }

                async searchMovie(query) {
                    try {
                        const response = await fetch(
                            `${this.apiBase}/search/movies/fast?query=${encodeURIComponent(query)}`,
                        );
                        if (!response.ok) throw new Error("Search failed");
                        return await response.json();
                    } catch (error) {
                        console.error("Search error:", error);
                        return [];
                    }
                }

                async getRelatedMovies(movieId) {
                    try {
                        const response = await fetch(
                            `${this.apiBase}/movies/${movieId}/related/fast`,
                        );
                        if (!response.ok)
                            throw new Error("Failed to get related movies");
                        const data = await response.json();
                        return data.slice(0, 8);
                    } catch (error) {
                        console.error("Related movies error:", error);
                        return [];
                    }
                }

                async getFullMovieDetails(movieId) {
                    try {
                        const response = await fetch(
                            `${this.apiBase}/movies/${movieId}/full`,
                        );
                        if (!response.ok)
                            throw new Error("Failed to get movie details");
                        return await response.json();
                    } catch (error) {
                        console.error("Movie details error:", error);
                        return null;
                    }
                }

                addMovieToNetwork(
                    movie,
                    depth = 0,
                    isNew = true,
                    fullDetails = null,
                ) {
                    const movieKey = `${movie.title}_${movie.year}`;
                    if (this.nodeMap.has(movieKey)) {
                        const existingNode = this.nodeMap.get(movieKey);
                        if (fullDetails) {
                            existingNode.fullDetails = fullDetails;
                            this.updateSidebar();
                        }
                        return existingNode;
                    }

                    const node = {
                        id: this.nextNodeId++,
                        title: movie.title,
                        year: movie.year,
                        traktId: movie.ids.trakt,
                        depth: depth,
                        movieKey: movieKey,
                        x: this.width / 2 + (Math.random() - 0.5) * 200,
                        y: this.height / 2 + (Math.random() - 0.5) * 200,
                        isNew: isNew,
                        fullDetails: fullDetails,
                        basicDetails: {
                            overview: movie.overview,
                            rating: movie.rating,
                            votes: movie.votes,
                            genres: movie.genres,
                            runtime: movie.runtime,
                            certification: movie.certification,
                            trailer: movie.trailer,
                        },
                    };

                    this.nodes.push(node);
                    this.nodeMap.set(movieKey, node);

                    this.applyFilters();
                    this.updateSidebar();
                    this.updateStats();

                    return node;
                }

                addConnection(sourceNode, targetNode, isNew = true) {
                    const existingLink = this.links.find(
                        (link) =>
                            (link.source.id === sourceNode.id &&
                                link.target.id === targetNode.id) ||
                            (link.source.id === targetNode.id &&
                                link.target.id === sourceNode.id),
                    );
                    if (existingLink) return existingLink;

                    const link = {
                        source: sourceNode,
                        target: targetNode,
                        isNew: isNew,
                    };
                    this.links.push(link);
                    return link;
                }

                async expandNode(node) {
                    if (node.expanding) return;
                    node.expanding = true;
                    this.showLoading(true, "Expanding network...");
                    this.showNotification(`Expanding ${node.title}...`);

                    try {
                        const relatedMovies = await this.getRelatedMovies(
                            node.traktId,
                        );
                        relatedMovies.forEach((relatedMovie) => {
                            const relatedNode = this.addMovieToNetwork(
                                relatedMovie,
                                node.depth + 1,
                                true,
                            );
                            this.addConnection(node, relatedNode, true);
                        });
                        this.showNotification(
                            `Added ${relatedMovies.length} related movies!`,
                            "success",
                        );
                    } catch (error) {
                        this.showNotification(
                            "Failed to expand network",
                            "error",
                        );
                    } finally {
                        node.expanding = false;
                        this.showLoading(false);
                        this.applyFilters();
                    }
                }

                applyFilters() {
                    const yearMin = parseInt(
                        document.getElementById("yearMin").value,
                    );
                    const yearMax = parseInt(
                        document.getElementById("yearMax").value,
                    );
                    const ratingMin = parseFloat(
                        document.getElementById("ratingMin").value,
                    );
                    const ratingMax = parseFloat(
                        document.getElementById("ratingMax").value,
                    );

                    const filteredNodes = this.nodes.filter((node) => {
                        const details =
                            node.fullDetails || node.basicDetails || {};
                        const rating = details.rating || 0;
                        const year = node.year || 0;

                        if (year < yearMin || year > yearMax) return false;
                        if (rating < ratingMin || rating > ratingMax)
                            return false;

                        if (this.selectedGenres.size > 0) {
                            const nodeGenres = details.genres || [];
                            if (
                                !nodeGenres.some((g) =>
                                    this.selectedGenres.has(g),
                                )
                            )
                                return false;
                        }
                        return true;
                    });

                    const filteredNodeIds = new Set(
                        filteredNodes.map((n) => n.id),
                    );
                    const filteredLinks = this.links.filter(
                        (link) =>
                            filteredNodeIds.has(link.source.id) &&
                            filteredNodeIds.has(link.target.id),
                    );

                    this.updateVisualization(filteredNodes, filteredLinks);
                }

                updateVisualization(nodes, links) {
                    this.simulation.nodes(nodes);
                    this.simulation.force("link").links(links);

                    const linkSelection = this.linkContainer
                        .selectAll("line")
                        .data(links, (d) => `${d.source.id}-${d.target.id}`);
                    linkSelection.exit().remove();
                    linkSelection
                        .enter()
                        .append("line")
                        .merge(linkSelection)
                        .attr(
                            "class",
                            (d) =>
                                `link ${d.isNew ? "new" : ""} ${this.isPathLink(d) ? "path-highlight" : ""}`,
                        );

                    const nodeSelection = this.nodeContainer
                        .selectAll("circle")
                        .data(nodes, (d) => d.id);
                    nodeSelection.exit().remove();
                    nodeSelection
                        .enter()
                        .append("circle")
                        .call(this.getDragBehavior())
                        .on("click", (event, d) => this.expandNode(d))
                        .on("mouseover", (event, d) =>
                            this.showTooltip(event, d),
                        )
                        .on("mouseout", () => this.hideTooltip())
                        .merge(nodeSelection)
                        .attr("r", (d) => (d.depth === 0 ? 15 : 10))
                        .attr("fill", (d) =>
                            this.colorScale(Math.min(d.depth, 3)),
                        )
                        .attr(
                            "class",
                            (d) =>
                                `node ${d.expanding ? "expanding" : ""} ${this.isPathNode(d) ? "path-highlight" : ""}`,
                        );

                    const labelSelection = this.labelContainer
                        .selectAll("text")
                        .data(nodes, (d) => d.id);
                    labelSelection.exit().remove();
                    labelSelection
                        .enter()
                        .append("text")
                        .merge(labelSelection)
                        .attr("class", "node-label")
                        .text((d) => d.title)
                        .style("display", this.showLabels ? "block" : "none");

                    this.simulation.alpha(0.3).restart();
                    this.simulation.on("tick", () => {
                        this.linkContainer
                            .selectAll("line")
                            .attr("x1", (d) => d.source.x)
                            .attr("y1", (d) => d.source.y)
                            .attr("x2", (d) => d.target.x)
                            .attr("y2", (d) => d.target.y);
                        this.nodeContainer
                            .selectAll("circle")
                            .attr("cx", (d) => d.x)
                            .attr("cy", (d) => d.y);
                        this.labelContainer
                            .selectAll("text")
                            .attr("x", (d) => d.x)
                            .attr("y", (d) => d.y + 25);
                    });

                    setTimeout(() => {
                        this.links.forEach((link) => (link.isNew = false));
                        this.nodes.forEach((node) => (node.isNew = false));
                    }, 1000);
                }

                getDragBehavior() {
                    return d3
                        .drag()
                        .on("start", (event, d) => {
                            if (!event.active)
                                this.simulation.alphaTarget(0.3).restart();
                            d.fx = d.x;
                            d.fy = d.y;
                        })
                        .on("drag", (event, d) => {
                            d.fx = event.x;
                            d.fy = event.y;
                        })
                        .on("end", (event, d) => {
                            if (!event.active) this.simulation.alphaTarget(0);
                            d.fx = null;
                            d.fy = null;
                        });
                }

                showTooltip(event, d) {
                    const tooltip = document.getElementById("tooltip");
                    tooltip.style.display = "block";
                    tooltip.style.left = event.pageX + 10 + "px";
                    tooltip.style.top = event.pageY - 10 + "px";

                    const details = d.fullDetails || d.basicDetails || {};
                    tooltip.innerHTML = `
                    <div style="font-weight: bold; margin-bottom: 8px; color: #f6e05e;">${d.title} (${d.year})</div>
                    <div>⭐ ${details.rating?.toFixed(1) || "N/A"}</div>
                    <div>Depth: ${d.depth} • Click to expand</div>
                `;
                }

                hideTooltip() {
                    document.getElementById("tooltip").style.display = "none";
                }

                updateSidebar() {
                    const movieList = document.getElementById("movieList");
                    if (this.nodes.length === 0) {
                        movieList.innerHTML = `<div style="text-align: center; color: var(--text-secondary); padding: 20px;">Search for a movie to start!</div>`;
                        return;
                    }

                    const sortedNodes = [...this.nodes].sort(
                        (a, b) =>
                            a.depth - b.depth ||
                            b.basicDetails.rating - a.basicDetails.rating,
                    );
                    movieList.innerHTML = sortedNodes
                        .map((node) => {
                            const details =
                                node.fullDetails || node.basicDetails || {};
                            return `
                        <div class="movie-item" onclick="movieNetwork.focusOnNode(${node.id})">
                            <div class="movie-header">
                                <div class="movie-title">${node.title}</div>
                                <div class="movie-rating">⭐ ${details.rating?.toFixed(1) || "N/A"}</div>
                            </div>
                            <div class="movie-meta">
                                <span class="movie-year">${node.year}</span>
                            </div>
                            <div class="movie-depth">Depth: ${node.depth}</div>
                            ${!node.fullDetails ? `<div class="load-details" onclick="event.stopPropagation(); movieNetwork.loadMovieDetails(${node.id})">📄 Load Details</div>` : ""}
                        </div>
                    `;
                        })
                        .join("");
                }

                updateStats() {
                    document.getElementById("networkStats").textContent =
                        `${this.nodes.length} movies, ${this.links.length} connections`;
                }

                focusOnNode(nodeId) {
                    const node = this.nodes.find((n) => n.id === nodeId);
                    if (!node) return;
                    const transform = d3.zoomIdentity
                        .translate(
                            this.width / 2 - node.x,
                            this.height / 2 - node.y,
                        )
                        .scale(1.5);
                    this.svg
                        .transition()
                        .duration(750)
                        .call(this.zoom.transform, transform);
                }

                async searchAndAddMovie() {
                    const searchInput = document.getElementById("movieSearch");
                    const query = searchInput.value.trim();
                    if (!query) return;

                    this.showLoading(true, "Searching...");
                    try {
                        const results = await this.searchMovie(query);
                        const movie = results[0]?.movie;
                        if (movie) {
                            const fullDetails = await this.getFullMovieDetails(
                                movie.ids.trakt,
                            );
                            const node = this.addMovieToNetwork(
                                movie,
                                0,
                                true,
                                fullDetails,
                            );
                            this.showNotification(
                                `Added "${movie.title}"!`,
                                "success",
                            );
                            searchInput.value = "";
                            setTimeout(() => this.focusOnNode(node.id), 500);
                        } else {
                            this.showNotification("Movie not found", "error");
                        }
                    } catch (error) {
                        this.showNotification("Search failed", "error");
                    } finally {
                        this.showLoading(false);
                    }
                }

                clearNetwork() {
                    this.nodes = [];
                    this.links = [];
                    this.nodeMap.clear();
                    this.nextNodeId = 0;
                    this.currentPath = [];
                    this.applyFilters();
                    this.updateSidebar();
                    this.updateStats();
                    this.showNotification("Network cleared", "success");
                }

                centerNetwork() {
                    const transform = d3.zoomIdentity.scale(1);
                    this.svg
                        .transition()
                        .duration(750)
                        .call(this.zoom.transform, transform);
                }

                toggleLabels() {
                    this.showLabels = !this.showLabels;
                    this.labelContainer
                        .selectAll("text")
                        .style("display", this.showLabels ? "block" : "none");
                }

                showLoading(show, text = "Loading...") {
                    const loading = document.getElementById("loadingIndicator");
                    loading.querySelector("div:last-child").textContent = text;
                    loading.style.display = show ? "block" : "none";
                }

                showNotification(message, type = "success") {
                    const notification =
                        document.getElementById("notification");
                    notification.textContent = message;
                    notification.className = `notification ${type} show`;
                    setTimeout(
                        () => notification.classList.remove("show"),
                        3000,
                    );
                }

                async saveNetworkToServer(name, description) {
                    try {
                        const networkData = {
                            name: name,
                            description: description,
                            nodes: this.nodes,
                            links: this.links.map((link) => ({
                                source:
                                    typeof link.source === "object"
                                        ? link.source.id
                                        : link.source,
                                target:
                                    typeof link.target === "object"
                                        ? link.target.id
                                        : link.target,
                            })),
                            settings: {
                                showLabels: this.showLabels,
                                colorScheme: "default",
                            },
                            seedMovie:
                                this.nodes.find((n) => n.depth === 0)?.title ||
                                null,
                        };

                        const response = await fetch(
                            `${this.apiBase.replace("/api", "")}/api/networks/save`,
                            {
                                method: "POST",
                                headers: {
                                    "Content-Type": "application/json",
                                },
                                body: JSON.stringify(networkData),
                            },
                        );

                        if (!response.ok)
                            throw new Error("Failed to save network");

                        const result = await response.json();
                        return result;
                    } catch (error) {
                        console.error("Save error:", error);
                        throw error;
                    }
                }

                async loadNetworkFromServer(networkId) {
                    try {
                        const response = await fetch(
                            `${this.apiBase.replace("/api", "")}/api/networks/${networkId}`,
                        );
                        if (!response.ok)
                            throw new Error("Failed to load network");

                        const networkData = await response.json();
                        return networkData;
                    } catch (error) {
                        console.error("Load error:", error);
                        throw error;
                    }
                }

                async getSavedNetworks() {
                    try {
                        const response = await fetch(
                            `${this.apiBase.replace("/api", "")}/api/networks`,
                        );
                        if (!response.ok)
                            throw new Error("Failed to get saved networks");

                        const networks = await response.json();
                        return networks;
                    } catch (error) {
                        console.error("Get networks error:", error);
                        return [];
                    }
                }

                async deleteNetworkFromServer(networkId) {
                    try {
                        const response = await fetch(
                            `${this.apiBase.replace("/api", "")}/api/networks/${networkId}`,
                            {
                                method: "DELETE",
                            },
                        );

                        if (!response.ok)
                            throw new Error("Failed to delete network");

                        const result = await response.json();
                        return result;
                    } catch (error) {
                        console.error("Delete error:", error);
                        throw error;
                    }
                }

                loadNetworkData(networkData) {
                    this.clearNetwork();
                    const nodeMap = new Map();
                    this.nodes = networkData.nodes.map((nodeData) => {
                        const node = { ...nodeData, id: this.nextNodeId++ };
                        nodeMap.set(nodeData.id, node);
                        this.nodeMap.set(node.movieKey, node);
                        return node;
                    });
                    this.links = networkData.links.map((linkData) => ({
                        source: nodeMap.get(linkData.source),
                        target: nodeMap.get(linkData.target),
                    }));
                    this.showLabels =
                        networkData.settings?.showLabels !== false;
                    this.applyFilters();
                    this.updateSidebar();
                    this.updateStats();
                    setTimeout(() => this.centerNetwork(), 500);
                }

                async loadMovieDetails(nodeId) {
                    const node = this.nodes.find((n) => n.id === nodeId);
                    if (!node || node.fullDetails) return;
                    this.showLoading(true, "Loading details...");
                    try {
                        const fullDetails = await this.getFullMovieDetails(
                            node.traktId,
                        );
                        if (fullDetails) {
                            node.fullDetails = fullDetails;
                            this.updateSidebar();
                            this.showNotification(
                                `Loaded details for ${node.title}`,
                                "success",
                            );
                        }
                    } catch (error) {
                        this.showNotification(
                            "Failed to load movie details",
                            "error",
                        );
                    } finally {
                        this.showLoading(false);
                    }
                }

                handleResize() {
                    this.width = window.innerWidth;
                    this.height = window.innerHeight - 80;
                    this.svg
                        .attr("width", this.width)
                        .attr("height", this.height);
                    this.simulation.force(
                        "center",
                        d3.forceCenter(this.width / 2, this.height / 2),
                    );
                    this.simulation.alpha(0.3).restart();
                }

                findPath(startNode, endNode) {
                    if (!startNode || !endNode) return [];
                    const queue = [[startNode, [startNode]]];
                    const visited = new Set([startNode.id]);
                    while (queue.length > 0) {
                        const [current, path] = queue.shift();
                        if (current.id === endNode.id) return path;
                        const neighbors = this.links
                            .map((l) =>
                                l.source.id === current.id
                                    ? l.target
                                    : l.target.id === current.id
                                      ? l.source
                                      : null,
                            )
                            .filter((n) => n && !visited.has(n.id));
                        for (const neighbor of neighbors) {
                            visited.add(neighbor.id);
                            queue.push([neighbor, [...path, neighbor]]);
                        }
                    }
                    return [];
                }

                highlightPath(path) {
                    this.currentPath = path;
                    this.applyFilters();
                }

                isPathNode(node) {
                    return this.currentPath.some((p) => p.id === node.id);
                }

                isPathLink(link) {
                    for (let i = 0; i < this.currentPath.length - 1; i++) {
                        if (
                            (this.currentPath[i].id === link.source.id &&
                                this.currentPath[i + 1].id ===
                                    link.target.id) ||
                            (this.currentPath[i].id === link.target.id &&
                                this.currentPath[i + 1].id === link.source.id)
                        ) {
                            return true;
                        }
                    }
                    return false;
                }

                highlightByQuery(query) {
                    const isDimmed = query.length > 0;
                    const q = query.toLowerCase();

                    this.nodeContainer
                        .selectAll(".node")
                        .classed(
                            "dimmed",
                            (d) =>
                                isDimmed && !d.title.toLowerCase().includes(q),
                        )
                        .classed(
                            "highlighted",
                            (d) =>
                                isDimmed && d.title.toLowerCase().includes(q),
                        );
                    this.labelContainer
                        .selectAll(".node-label")
                        .classed(
                            "dimmed",
                            (d) =>
                                isDimmed && !d.title.toLowerCase().includes(q),
                        )
                        .classed(
                            "highlighted",
                            (d) =>
                                isDimmed && d.title.toLowerCase().includes(q),
                        );
                    this.linkContainer
                        .selectAll(".link")
                        .classed("dimmed", isDimmed);
                }
            }

            let movieNetwork;

            function searchAndAddMovie() {
                movieNetwork.searchAndAddMovie();
            }
            function clearNetwork() {
                movieNetwork.clearNetwork();
            }
            function centerNetwork() {
                movieNetwork.centerNetwork();
            }
            function toggleLabels() {
                movieNetwork.toggleLabels();
            }
            function applyFilters() {
                movieNetwork.applyFilters();
            }
            function toggleSearchPanel() {
                document.getElementById("searchPanel").classList.toggle("open");
            }

            function findAndShowPath() {
                const fromTitle = document
                    .getElementById("pathFrom")
                    .value.trim();
                const toTitle = document.getElementById("pathTo").value.trim();
                if (!fromTitle || !toTitle)
                    return movieNetwork.showNotification(
                        "Please enter both movie titles",
                        "warning",
                    );

                const startNode = movieNetwork.nodes.find(
                    (n) => n.title.toLowerCase() === fromTitle.toLowerCase(),
                );
                const endNode = movieNetwork.nodes.find(
                    (n) => n.title.toLowerCase() === toTitle.toLowerCase(),
                );

                if (!startNode || !endNode)
                    return movieNetwork.showNotification(
                        "One or both movies not in network",
                        "error",
                    );

                const path = movieNetwork.findPath(startNode, endNode);
                const resultDiv = document.getElementById("pathResult");
                if (path.length > 0) {
                    resultDiv.textContent = `Path found: ${path.map((p) => p.title).join(" → ")}`;
                    resultDiv.style.display = "block";
                    movieNetwork.highlightPath(path);
                } else {
                    resultDiv.textContent =
                        "No path found between these movies.";
                    resultDiv.style.display = "block";
                    movieNetwork.highlightPath([]);
                }
            }

            function clearFilters() {
                document.getElementById("quickSearch").value = "";
                document.getElementById("yearMin").value = 1900;
                document.getElementById("yearMax").value = 2024;
                document.getElementById("ratingMin").value = 0;
                document.getElementById("ratingMax").value = 10;
                document
                    .querySelectorAll(".genre-tag.selected")
                    .forEach((t) => t.classList.remove("selected"));
                movieNetwork.selectedGenres.clear();
                movieNetwork.highlightPath([]);
                movieNetwork.applyFilters();
                movieNetwork.showNotification("Filters cleared", "success");
            }

            function showSaveDialog() {
                if (movieNetwork.nodes.length === 0)
                    return movieNetwork.showNotification(
                        "No network to save",
                        "error",
                    );
                const modal = document.getElementById("saveModal");
                const seedMovie =
                    movieNetwork.nodes.find((n) => n.depth === 0)?.title ||
                    "Movie";
                document.getElementById("networkName").value =
                    `${seedMovie} Network`;
                document.getElementById("savePreview").innerHTML =
                    `Movies: ${movieNetwork.nodes.length}, Connections: ${movieNetwork.links.length}`;
                modal.style.display = "flex";
            }

            function closeSaveDialog() {
                document.getElementById("saveModal").style.display = "none";
            }

            async function saveNetwork() {
                const name = document
                    .getElementById("networkName")
                    .value.trim();
                const description = document
                    .getElementById("networkDescription")
                    .value.trim();
                if (!name)
                    return movieNetwork.showNotification(
                        "Please enter a name",
                        "error",
                    );

                movieNetwork.showLoading(true, "Saving...");
                try {
                    const result = await movieNetwork.saveNetworkToServer(
                        name,
                        description,
                    );
                    if (result.success) {
                        movieNetwork.showNotification(
                            `Network "${name}" saved!`,
                            "success",
                        );
                        closeSaveDialog();
                    } else {
                        movieNetwork.showNotification(
                            "Failed to save network",
                            "error",
                        );
                    }
                } catch (error) {
                    movieNetwork.showNotification(
                        "Failed to save network",
                        "error",
                    );
                } finally {
                    movieNetwork.showLoading(false);
                }
            }

            async function showLoadDialog() {
                document.getElementById("loadModal").style.display = "flex";
                await refreshNetworksList();
            }

            function closeLoadDialog() {
                document.getElementById("loadModal").style.display = "none";
            }

            async function refreshNetworksList() {
                const listContainer =
                    document.getElementById("savedNetworksList");
                listContainer.innerHTML = "Loading...";
                try {
                    const networks = await movieNetwork.getSavedNetworks();
                    if (networks.length === 0) {
                        listContainer.innerHTML = "No saved networks found.";
                        return;
                    }
                    listContainer.innerHTML = networks
                        .map(
                            (net) => `
                    <div class="saved-network-item">
                        <div class="network-item-header">
                            <div class="network-item-title">${net.name}</div>
                            <div class="network-item-date">${new Date(net.createdAt).toLocaleDateString()}</div>
                        </div>
                        <div class="network-item-actions">
                            <button class="action-btn" onclick="loadSelectedNetwork('${net.id}')">📂 Load</button>
                            <button class="action-btn danger" onclick="deleteNetwork('${net.id}')">🗑️ Delete</button>
                        </div>
                    </div>
                `,
                        )
                        .join("");
                } catch (error) {
                    listContainer.innerHTML = "Failed to load networks.";
                }
            }

            async function loadSelectedNetwork(networkId) {
                movieNetwork.showLoading(true, "Loading network...");
                try {
                    const networkData =
                        await movieNetwork.loadNetworkFromServer(networkId);
                    movieNetwork.loadNetworkData(networkData);
                    movieNetwork.showNotification(
                        `Network "${networkData.name}" loaded!`,
                        "success",
                    );
                    closeLoadDialog();
                } catch (error) {
                    movieNetwork.showNotification(
                        "Failed to load network",
                        "error",
                    );
                } finally {
                    movieNetwork.showLoading(false);
                }
            }

            async function deleteNetwork(networkId) {
                if (!confirm("Are you sure you want to delete this network?"))
                    return;
                try {
                    await movieNetwork.deleteNetworkFromServer(networkId);
                    movieNetwork.showNotification("Network deleted", "success");
                    refreshNetworksList();
                } catch (error) {
                    movieNetwork.showNotification(
                        "Failed to delete network",
                        "error",
                    );
                }
            }

            window.addEventListener("click", (event) => {
                if (event.target === document.getElementById("saveModal"))
                    closeSaveDialog();
                if (event.target === document.getElementById("loadModal"))
                    closeLoadDialog();
            });

            document.addEventListener("DOMContentLoaded", () => {
                movieNetwork = new EnhancedMovieNetwork();
            });
        </script>
    </body>
</html>
